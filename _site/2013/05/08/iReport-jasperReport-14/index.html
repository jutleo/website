<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>iReport+jasperReport之客户端打印 (续)</title>
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
        <!-- Custom CSS -->
        <link rel="stylesheet" href="/static/css/leo.css">
        <link rel="stylesheet" href="/static/css/prettify.css">

    </head>
    <body>
      <div class="leo-head">
        <ul class="leo-nav">
  
    <li><a class="leo-nav-item" href="/">首页</a></li>
  
    <li><a class="leo-nav-item" href="/category.html">归档</a></li>
  
    <li><a class="leo-nav-item" href="/andy.html">豆豆</a></li>
  
    <li><a class="leo-nav-item last" href="/contant.html">联系我</a></li>
  
</ul>

      </div>
          </div>
      <div class="container">
        <div class="row">
          <div class="col-md-8"><div class="leo-category"><h1 class="leo-articel-title">iReport+jasperReport之客户端打印 (续)</h1>
<div class="post">
<p>接着上篇，jasperReport 实现客户端主要是依靠applet，但是我们所有的操作不可能在applet中实现吧，这样也不算一个好的应用。<br>
<strong>考虑以下几点：</strong><br>
1. javascript 和applet互相通信。applet和前台界面交互，可以让客户感觉不到有applet的存在。<br>
2. applet和后台相互通信。applet既可以接受后台转递的参数、对象流等等 还可以把信息返回到后台。<br>
3. applet只实现打印和预览，主要的业务操作需要在后台完成。<br>
上篇中提到print.js：<br>
新建一jsp页面 PrintReportApplet.jsp，此jsp页面就一个按钮  </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;input type=&quot;submit&quot; value=&quot;预览&quot; onclick=&quot;reportViewer()&quot; /&gt; 
</code></pre></div>
<p>这样我们就可以在当前页面中引用到applet了， <code>document.applets.myApplet.reportViewer()</code> 拿到<code>applet</code>的窗口句柄后调用<code>applet</code>的<code>reportViewer()</code>方法<br>
我们也可以在此jsp页面写一个初始化的方法传递参数到<code>applet</code>中，当然也可以直接传递参数到<code>reportViewer（parameter String）;</code></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">function getParameters() { 
    return &quot;&amp;pid=0001&quot;
}
</code></pre></div>
<p>在<code>print.js</code>中指定 <code>&lt;PARAM NAME=&quot;CODE&quot; VALUE=&quot;com.isoftstone.pcis.report.print.applet.PrinterApplet&quot; /&gt;</code>
<strong>PrinterApplet中reportViewer</strong> </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">// javascript预览报表
public void reportViewer() {
    try {
        win = JSObject.getWindow(this);
        paraStr = win.eval(&quot;getParameters()&quot;).toString();

        if (&quot;&quot;.equals(paraStr) || paraStr == null) {
            return;
        }
        System.out.println(&quot;paraStr=======&gt;&quot; + paraStr);

    } catch (Exception e1) {
        e1.printStackTrace();
    }
    if (url == null) {
        if (requestUrl != null) {
            try {
                /*
                 * applet与Servlet交互 URL传递页面传来的参数请求服务器Servlet
                 * 把applet传递的参数追加到servlet中 2008-10-14 jutleo
                 */

                url = new URL(getCodeBase(), requestUrl + &quot;?printView=true&quot;
                        + paraStr);

                if (url == null) {
                    JOptionPane.showMessageDialog(this,
                            &quot;Source URL not specified&quot;);
                } else {
                    InputStream in = url.openStream();
                    ObjectInputStream objIn = new ObjectInputStream(in);
                    Object obj = objIn.readObject();
                    if (obj instanceof JasperPrint) {

                    } else {
                        JOptionPane.showMessageDialog(this, obj.toString());
                        return;
                    }

                    if (jasperPrint == null) {
                        // 根据Servlet返回的URL（ObjectStream）产生JasperPrint对象
                        jasperPrint = (JasperPrint) obj;

                    }
                    // 拦截出现空报表问题
                    if (jasperPrint != null
                            &amp;&amp; jasperPrint.getPages().size() &gt; 0) {
                        /*
                         * 调用JasperReport.jar中JasperViewer绘制报表Frame
                         * JasperViewer继承自JFrame，采用setDefaultCloseOperation响应关闭窗口事件
                         */

                        ViewerFrame viewerFrame = new ViewerFrame(this
                                .getAppletContext(), jasperPrint);

                        viewerFrame.setVisible(true);
                        //viewerFrame.show();

                        // JasperViewer viewer = new
                        // JasperViewer(jasperPrint);
                        // viewer.setVisible(true);
                        // viewer.setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
                        // 如果请求为空弹出对话框予以提示
                    } else {
                        JOptionPane
                                .showMessageDialog(this,
                                        &quot;Please check Your Report SQL! It resulted in empty Report! &quot;);
                        return;
                    }
                }
            } catch (Exception e) {
                StringWriter swriter = new StringWriter();
                PrintWriter pwriter = new PrintWriter(swriter);
                e.printStackTrace(pwriter);
                JOptionPane.showMessageDialog(this, swriter.toString());
            } finally {// 全打套打URL不一样释放对象 by laoshulin
                url = null;
                jasperPrint = null;
                win = null;
            }
        }
    }
}
</code></pre></div>
<p><code>JSObject</code> 对象的使用<code>google</code>一下有很多哦，<code>requestUrl = getParameter(&quot;REPORT_URL&quot;);</code>为<code>print.js</code>中配置的请求，之后我们<code>new URL</code>带上我们的参数去请求远程资源。  </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;servlet-mapping&gt;
    &lt;servlet-name&gt;ReportServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/report.view&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;

public void doGet(HttpServletRequest request, HttpServletResponse response)
        throws ServletException, IOException {
    try {

        /*
         * Servlet中可这样取得打印或是预览操作，添加此功能针对套打预览 String
         * view=request.getParameter(&quot;printView&quot;); boolean
         * isView=&quot;true&quot;.equalsIgnoreCase(view)?true:false; String
         * print=request.getParameter(&quot;print&quot;); boolean
         * isPrint=&quot;true&quot;.equalsIgnoreCase(print)?true:false;
         */

        // 拿参数
        String pid = request.getParameter(&quot;pid&quot;);
        String form = request.getParameter(&quot;format&quot;);
        // 编译报表耗时，修改为编译好的报表
        /*
         * JasperReport jasperReport = JasperCompileManager
         * .compileReport(&quot;D:\\workspace\\report\\AppletTest.jasper&quot;);
         */
        // 直接使用编译好的文件
        //JasperReport jasperReport = (JasperReport) JRLoader.loadObject(&quot;D:\\workspace\\report\\AppletTest.jasper&quot;);
        JasperReport jasperReport = (JasperReport) JRLoader
                .loadObjectFromLocation(&quot;D:\\workspace\\report\\AppletTest.jasper&quot;);
        HashMap mapParam = new HashMap();
        mapParam.put(&quot;imageParam&quot;, &quot;D:\\workspace\\report\\eg_smile.gif&quot;);
        /*
         * 此参数用来控制是否显示图片
         * 第二个参数在报表中设置为String类型
         */
        mapParam.put(&quot;isShowImage&quot;, &quot;true&quot;);
        // 生成jasperPrint对象
        JasperPrint jasperPrint = JasperFillManager.fillReport(jasperReport,
                mapParam, new JREmptyDataSource());
        System.out.println(jasperPrint.getPageHeight()+&quot;$$$$$$$$$$$$&quot;+jasperPrint.getPageWidth()+&quot;**********&quot;+jasperPrint.getPages());

        response.setContentType(&quot;application/octet-stream&quot;);
        response.setBufferSize(8986000);
        ServletOutputStream outStream = response.getOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(outStream);
        oos.writeObject(jasperPrint);
        // outStream.flush();
        // oos.flush();

        // outStream.close();
        // oos.close();

        //outStream.flush();
    } catch (Exception e) {
        e.printStackTrace();
    }
}
</code></pre></div>
<p>请求到远程资源完全可以按照业务需求实现自己的<code>jasperReport</code> 了，最终我们只要把一个<code>JasperPrint</code>对象输出到客户端就可以了。<br>
客户端通过打开<code>InputStream in = url.openStream();</code>实现还原<code>jasperPrint</code>对象，从而实现打印或者预览。<br>
客户端打印可以前的方法是一样的：<br>
编译、填充、生成JasperPrint对象、预览或打印<br>
上篇有人提到<a href="http://jutleo.github.io/2013/05/03/iReport-jasperReport-11/">打印和预览实现动态控制套打背景</a>,建议你多看看 iReport+jasperReport之图片控件。<br>
实现原理是一样的，只是把JasperPrint在客户端处理了一下哦。</p>

</div>
<p class="leo-protect">
  作者：
  <a href="/">leo</a>
  　发布时间：2013年05月08日
  <br>
  原文：
  <a href="/2013/05/08/iReport-jasperReport-14">iReport+jasperReport之客户端打印 (续)</a>
  <br>
  标签： iReport、jasperReport
  <br/>
  版权所有，转载时必须以链接形式注明作者和原出处并保留本声明。
  <br>
</p>
<script type="text/javascript" src="/static/js/jquery-1.8.3.min.js"></script>
<script type="text/javascript" src="/static/js/prettify.js"></script>
<script type="text/javascript">
  $(function(){
    $("pre").addClass("prettyprint linenums");
    prettyPrint();
  });
</script>

<!-- Duoshuo Comment BEGIN -->
  <div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"jutleo"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- Duoshuo Comment END --></div></div>
          <div class="col-md-4">
            <div class="list-group">
              <a href="#" class="list-group-item list-group-item-success disabled">分类</a>
              
              <a href="/db/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">1</span>db </a>
              
              <a href="/server/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">2</span>server </a>
              
              <a href="/office/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">1</span>office </a>
              
              <a href="/javascript/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">6</span>javascript </a>
              
              <a href="/ireport/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">15</span>ireport </a>
              
              <a href="/blog/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">1</span>blog </a>
              
              <a href="/orm/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">2</span>orm </a>
              
              <a href="/technology/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">1</span>technology </a>
              
              <a href="/life/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">3</span>life </a>
              
              <a href="/spring/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">5</span>spring </a>
              
            </div>
            <div class="leo-article-category">
              <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=2975520964&verifier=eac976c7&dpc=1"></iframe>
            </div>

          </div>
      </div>

        </div>
        
      <div class="leo-foot">
        <p>
 Copyright &copy; 2010 - 2014 &nbsp;jutleo@gmail.com. 保留所有权利。
</p>
      </div>
    </body>
</html>
