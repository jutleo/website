<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>spring security CAS集成</title>
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
        <!-- Custom CSS -->
        <link rel="stylesheet" href="/static/css/leo.css">
        <link rel="stylesheet" href="/static/css/prettify.css">

    </head>
    <body>
      <div class="leo-head">
        <ul class="leo-nav">
  
    <li><a class="leo-nav-item" href="/">首页</a></li>
  
    <li><a class="leo-nav-item" href="/category.html">归档</a></li>
  
    <li><a class="leo-nav-item" href="/andy.html">豆豆</a></li>
  
    <li><a class="leo-nav-item last" href="/contant.html">联系我</a></li>
  
</ul>

      </div>
          </div>
      <div class="container">
        <div class="row">
          <div class="col-md-8"><div class="leo-category"><h1 class="leo-articel-title">spring security CAS集成</h1>
<div class="post">
<h2>开篇</h2>

<p>&emsp;接上篇，<code>spring security</code>如何和<code>cas</code>集成？spring-security自己实现了cas的整合，建spring-security-cas jar源码</p>

<h2>先看一个完整的配置</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">//指定cas的拦截切入点，配置拦截的URL请求地址,引用切入点拦截过滤
&lt;sec:http entry-point-ref=&quot;casProcessingFilterEntryPoint&quot;&gt;
    &lt;sec:intercept-url pattern=&quot;/core/login/**&quot; filters=&quot;none&quot; /&gt;
    &lt;sec:intercept-url pattern=&quot;/core/skin/**&quot; filters=&quot;none&quot; /&gt;
    &lt;sec:intercept-url pattern=&quot;/core/common/**&quot; filters=&quot;none&quot; /&gt;
    &lt;sec:intercept-url pattern=&quot;/core/js/**&quot; filters=&quot;none&quot; /&gt;      
    &lt;sec:intercept-url pattern=&quot;/**&quot; access=&quot;ROLE_EVERYONE&quot; /&gt;
    //指定登出地址，不明白为什么这么设计，应该指定到切入点才对
    &lt;sec:logout logout-success-url=&quot;http://localhost:8008/cas/logout&quot;/&gt;
&lt;/sec:http&gt;

//切入点拦截过滤配置，需要指定登录URL及serviceProperties两个属性
&lt;bean id=&quot;casProcessingFilterEntryPoint&quot; class=&quot;org.springframework.security.ui.cas.CasProcessingFilterEntryPoint&quot;&gt;
    &lt;property name=&quot;loginUrl&quot; value=&quot;http://localhost:8008/cas/login&quot;/&gt;
    &lt;property name=&quot;serviceProperties&quot; ref=&quot;serviceProperties&quot;/&gt;
&lt;/bean&gt;

//需要配置认证管理器，默认即可，`spring security 3`之后的版本，权限管理及提供者的配置更直观些
&lt;sec:authentication-manager alias=&quot;authenticationManager&quot;/&gt;

&lt;bean id=&quot;casProcessingFilter&quot; class=&quot;org.springframework.security.ui.cas.CasProcessingFilter&quot;&gt;
    &lt;sec:custom-filter after=&quot;CAS_PROCESSING_FILTER&quot;/&gt;
    &lt;property name=&quot;authenticationManager&quot; ref=&quot;authenticationManager&quot;/&gt;
    &lt;property name=&quot;authenticationFailureUrl&quot; value=&quot;/casfailed.jsp&quot;/&gt;
    &lt;property name=&quot;defaultTargetUrl&quot; value=&quot;/&quot;/&gt;
    &lt;property name=&quot;proxyGrantingTicketStorage&quot; ref=&quot;proxyGrantingTicketStorage&quot; /&gt;
    &lt;property name=&quot;proxyReceptorUrl&quot; value=&quot;/proxy/receptor&quot; /&gt;
    &lt;property name=&quot;filterProcessesUrl&quot; value=&quot;/j_spring_security_check&quot;/&gt;
&lt;/bean&gt;
//cas权限提供者，由spring实现
&lt;bean id=&quot;casAuthenticationProvider&quot; class=&quot;org.springframework.security.providers.cas.CasAuthenticationProvider&quot;&gt;
    &lt;sec:custom-authentication-provider /&gt; //标识是自定义来的
    &lt;property name=&quot;userDetailsService&quot; ref=&quot;userDetailsService&quot;/&gt; //注入userDetailsService实现
    &lt;property name=&quot;serviceProperties&quot; ref=&quot;serviceProperties&quot; /&gt; //注入serviceProperties属性实现
    //票据验证，由cas-client实现
    &lt;property name=&quot;ticketValidator&quot;&gt;
        &lt;bean class=&quot;org.jasig.cas.client.validation.Cas20ServiceTicketValidator&quot;&gt;
            &lt;constructor-arg index=&quot;0&quot; value=&quot;http://localhost:8008/cas&quot; /&gt;
            &lt;property name=&quot;proxyGrantingTicketStorage&quot; ref=&quot;proxyGrantingTicketStorage&quot; /&gt;
            &lt;property name=&quot;proxyCallbackUrl&quot; value=&quot;http://localhost:8080/leo/proxy/receptor&quot; /&gt;
        &lt;/bean&gt;
    &lt;/property&gt;
    &lt;property name=&quot;key&quot; value=&quot;an_id_for_this_auth_provider_only&quot;/&gt;
&lt;/bean&gt;

&lt;bean id=&quot;proxyGrantingTicketStorage&quot; class=&quot;org.jasig.cas.client.proxy.ProxyGrantingTicketStorageImpl&quot; /&gt;

//切入点需要的serviceProperties属性实现，
&lt;bean id=&quot;serviceProperties&quot; class=&quot;org.springframework.security.ui.cas.ServiceProperties&quot;&gt;
    &lt;property name=&quot;service&quot; value=&quot;http://localhost:8008/leo/j_spring_security_check&quot;/&gt;
    &lt;property name=&quot;sendRenew&quot; value=&quot;false&quot;/&gt;//敏感配置，表示客户端已经存在票据也要去cas-server上重新登录
&lt;/bean&gt;
&lt;!-- 用户信息 实现了UserdetailsService接口，实际上继承自己JdbcDaoImpl类--&gt;
&lt;bean id=&quot;userDetailsService&quot;
    class=&quot;org.leo.security.SecurityJdbcDaoImpl&quot;  lazy-init=&quot;true&quot;&gt;
    &lt;property name=&quot;dataSource&quot;&gt;
        &lt;ref bean=&quot;dataSource&quot; /&gt;
    &lt;/property&gt;
    &lt;property name=&quot;usersByUsernameQuery&quot;&gt;
        &lt;value&gt;
            SELECT op.C_OPER_ID,op.C_OPER_CNM,opdpt.C_DPT_CDE,dpt.C_DPT_ABR,op.C_PASSWD,op.C_IS_VALID,op.C_OP_DIFF,op.C_DPT_DIFF,op.C_PRD_DIFF,op.C_DPT_PERM,dpt.C_DPT_REL_CDE,dpt.N_DPT_LEVL,op.C_REL_CDE,op.C_SRC,dpt.C_DPT_DISP_CDE,dpt.C_DPT_OUT_CDE
            FROM WEB_ORG_OPER op,WEB_GRT_USR_OP_DPT opdpt,WEB_ORG_DPT dpt
            WHERE  opdpt.C_DPT_CDE = dpt.C_DPT_CDE
            AND op.C_OPER_ID = opdpt.C_OPER_ID
            AND op.C_OPER_ID = ?
        &lt;/value&gt;
    &lt;/property&gt;
    &lt;property name=&quot;authoritiesByUsernameQuery&quot;&gt;
        &lt;value&gt;
            SELECT DISTINCT op.C_OPER_ID,r.c_opgrp_cde
            FROM WEB_GRT_ROLE r,WEB_GRT_USR_ROLE ur,WEB_ORG_OPER op,WEB_GRT_USR_OP_DPT opdpt
            WHERE r.c_opgrp_cde =ur.c_opgrp_cde AND ur.C_OPER_ID =opdpt.C_OPER_ID  AND ur.C_OPER_ID =op.C_OPER_ID AND ur.C_DPT_CDE =opdpt.C_DPT_CDE 
            AND op.C_OPER_ID = ?
        &lt;/value&gt;
    &lt;/property&gt;
&lt;/bean&gt;
</code></pre></div>
<p>&emsp;以上都是spring 提供的基于cas-server的安全认证实现配置，照搬即可，注释里有说明。</p>

<p>&emsp;为了能让spring security和客户端结合，我们需要在<code>web.xml</code>里加载<code>springSecurityFilterChain</code>,指定拦截请求标识，默认配置如下：  </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;filter&gt;
    &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
    &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;
&lt;/filter&gt;
&lt;filter-mapping&gt;
    &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
    &lt;url-pattern&gt;/j_spring_security_check&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
&lt;filter-mapping&gt;
    &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
</code></pre></div>
<p>&emsp;OK，启动你的web工程，看看<code>spring security</code>基于开源SSO的实现cas认证有没有正确运行呢？</p>

</div>
<p class="leo-protect">
  作者：
  <a href="/">leo</a>
  　发布时间：2014年05月13日
  <br>
  原文：
  <a href="/2014/05/13/spring-security-03">spring security CAS集成</a>
  <br>
  标签： spring
  <br/>
  版权所有，转载时必须以链接形式注明作者和原出处并保留本声明。
  <br>
</p>
<script type="text/javascript" src="/static/js/jquery-1.8.3.min.js"></script>
<script type="text/javascript" src="/static/js/prettify.js"></script>
<script type="text/javascript">
  $(function(){
    $("pre").addClass("prettyprint linenums");
    prettyPrint();
  });
</script>

<!-- Duoshuo Comment BEGIN -->
  <div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"jutleo"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- Duoshuo Comment END --></div></div>
          <div class="col-md-4">
            <div class="list-group">
              <a href="#" class="list-group-item list-group-item-success disabled">分类</a>
              
              <a href="/db/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">1</span>db </a>
              
              <a href="/server/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">2</span>server </a>
              
              <a href="/office/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">1</span>office </a>
              
              <a href="/javascript/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">6</span>javascript </a>
              
              <a href="/ireport/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">15</span>ireport </a>
              
              <a href="/blog/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">1</span>blog </a>
              
              <a href="/orm/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">2</span>orm </a>
              
              <a href="/technology/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">1</span>technology </a>
              
              <a href="/life/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">3</span>life </a>
              
              <a href="/spring/"  class="list-group-item" title="查看所有此分类文章列表"><span class="badge">5</span>spring </a>
              
            </div>
            <div class="leo-article-category">
              <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=2975520964&verifier=eac976c7&dpc=1"></iframe>
            </div>

          </div>
      </div>

        </div>
        
      <div class="leo-foot">
        <p>
 Copyright &copy; 2010 - 2014 &nbsp;jutleo@gmail.com. 保留所有权利。
</p>
      </div>
    </body>
</html>
